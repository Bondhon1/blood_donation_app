{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4 full-width-on-mobile">

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
    {% endwith %}

    <div class="card shadow-lg">
        <!-- Cover Photo -->
        <div class="position-relative cover-container">
            <img id="cover-photo"
     src="{{ url_for('static', filename='profile_pics/' + (user.cover_photo if user.cover_photo else 'default.jpg')) }}"
     class="img-fluid cover-image">

            <input type="file" id="cover-photo-input" class="d-none" accept="image/*" onchange="uploadImage('cover')">
            <button class="btn btn-outline-light position-absolute top-0 end-0 m-0 shadow" onclick="document.getElementById('cover-photo-input').click();">
                <i class="fas fa-camera"></i> Change Cover
            </button>
        </div>
        
        <!-- Profile Picture -->
        <div class="position-relative text-center profile-container">
            <img id="profile-pic" src="{{ url_for('static', filename='profile_pics/' + user.profile_picture) }}" class="rounded-circle profile-pic">
            <input type="file" id="profile-pic-input" class="d-none" accept="image/*" onchange="uploadImage('profile')">
            <button class="btn btn-sm btn-outline-secondary position-absolute edit-profile-btn" onclick="document.getElementById('profile-pic-input').click();">
                <i class="fas fa-camera"></i>
            </button>
            <h3 class="mt-3 fw-bold">{{ user.username }}</h3>
        </div>


        <!-- Tabs Navigation -->
        <ul class="nav nav-pills nav-fill mt-5 profile-tabs p-2 rounded" id="profileTabs">
            <li class="nav-item"><a class="nav-link active" id="info-tab" href="#" onclick="showTab(event, 'info')"><i class="fas fa-user"></i> Profile Info</a></li>
            <li class="nav-item"><a class="nav-link" id="requests-tab" href="#" onclick="showTab(event, 'requests')"><i class="fas fa-history"></i> Past Requests</a></li>
            <li class="nav-item"><a class="nav-link" id="new-request-tab" href="#" onclick="showTab(event, 'new-request')"><i class="fas fa-plus-circle"></i> New Request</a></li>
            <li class="nav-item"><a class="nav-link" id="donor-tab" href="#" onclick="showTab(event, 'donor')"><i class="fas fa-hand-holding-heart"></i> Become a Donor</a></li>
        </ul>

        <div class="card-body">
            <!-- Profile Info Tab -->
            <div id="info" class="profile-tab active-tab">
                <!-- Profile Form -->
                <form id="profile-form">
                    <div class="mb-3">
                        <label class="fw-bold">Username</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-user-tag"></i></span>
                            <input type="text" class="form-control" value="{{ user.username }}" readonly>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="fw-bold">Email</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                            <input type="email" class="form-control" value="{{ user.email }}" readonly>
                        </div>
                    </div>

                    {% set fields = [
                        ("name", "Full Name", "user", user.name),
                        ("phone", "Phone", "phone", user.phone),
                        ("blood_group", "Blood Group", "tint", user.blood_group),
                        ("medical_history", "Medical History", "notes-medical", user.medical_history),
                        ("address", "Address", "map-marker-alt", user.address)
                    ] %}

                    {% for field_id, label, icon, value in fields %}
                    <div class="mb-3">
                        <label class="fw-bold">{{ label }}</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-{{ icon }}"></i></span>
                            <input type="text" class="form-control editable-field" id="{{ field_id }}" value="{{ value }}" readonly>
                            <button class="btn btn-sm btn-outline-primary edit-btn" type="button" onclick="enableEdit('{{ field_id }}')">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- Division Selection -->
                    <div class="mb-3">
                        <label class="fw-bold">Division</label>
                        <select id="division" class="form-select" onchange="loadDistricts()" required>
                            <option value="" {% if not user.division_id %}selected{% endif %}>Select Division</option>
                            {% for division in divisions %}
                                <option value="{{ division.id }}" {% if user.division_id == division.id %}selected{% endif %}>
                                    {{ division.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>





                    <!-- District Selection -->
                    <div class="mb-3">
                        <label class="fw-bold">District</label>
                        <select id="district" class="form-select" onchange="loadUpazilas()" required>
                            <option value="">Select District</option>
                        </select>
                    </div>

                    <!-- Upazila Selection -->
                    <div class="mb-3">
                        <label class="fw-bold">Upazila/City Corporation</label>
                        <select id="upazila" class="form-select" required>
                            <option value="">Select Upazila/City Corporation</option>
                        </select>
                    </div>

                    <button class="btn btn-success mt-3 w-100 shadow" type="button" onclick="saveProfile()">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </form>


            </div>

            
            <div id="requests" class="profile-tab">
                
            
                <div id="request-feed">
                    <!-- Blood request posts will be loaded here dynamically -->
                </div>
                <div id="loading-spinner" class="text-center my-4" style="display: none;">
                    <div class="spinner-border text-danger" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                
            
                <!--<button id="load-more" class="btn btn-outline-primary w-100 mt-3 d-none" onclick="loadMoreRequests()">Load More</button>>-->
            </div>
            

            <!-- New Request Tab -->
            <div id="new-request" class="profile-tab">
                        

                        <form action="{{ url_for('new_blood_request') }}" method="POST" enctype="multipart/form-data">
                            {{ form.hidden_tag() }}  <!-- Flask-WTF CSRF token -->

                            <div class="mb-3">
                                <label class="fw-bold">Patient Name</label>
                                <input type="text" name="patient_name" class="form-control" required>
                                <span class="form-text text-danger"></span> <!-- âœ… Always add this -->
                            </div>

                            <div class="mb-3">
                                <label class="fw-bold">Gender</label>
                                <select name="gender" class="form-select" required>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="fw-bold">Required Date</label>
                                <input type="date" name="required_date" class="form-control" required>
                            </div>

                            <div class="mb-3">
                                <label class="fw-bold">Required Blood Group</label>
                                <select name="blood_group" class="form-select" required>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="fw-bold">Amount of Blood Needed (in bags)</label>
                                <input type="number" name="amount_needed" class="form-control" min="1" required>
                            </div>

                            <div class="mb-3">
                                <label class="fw-bold">Hospital Name</label>
                                <input type="text" name="hospital_name" class="form-control" required>
                                <span class="form-text text-danger"></span>
                            </div>

                            <div class="mb-3">
                                <label class="fw-bold">Urgency Status</label>
                                <select name="urgency_status" class="form-select" required>
                                    <option value="Normal">Normal</option>
                                    <option value="Urgent">Urgent</option>
                                    <option value="Critical">Critical</option>
                                </select>
                            </div>

                            
                            <div class="mb-3">
                                <label class="fw-bold">Smoker Preference</label>
                                <select name="smoker_preference" class="form-select" required>  <!-- âœ… FIXED NAME -->
                                    <option value="Allow Smokers">Allow Smokers to donate</option>
                                    <option value="Avoid Smokers">Prefer avoiding smokers</option>
                                    <option value="No smokers">No Smokers</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="fw-bold">Reason for Request</label>
                                <textarea name="reason" class="form-control" rows="3" required></textarea>
                                <span class="form-text text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label class="fw-bold">Upload Supporting Images (optional, max 10)</label>
                                <input type="file" name="images" id="imageUpload" class="form-control" accept="image/*" multiple>
                                <div id="imagePreviews" class="d-flex flex-wrap gap-2 mt-2"></div>

                                <small class="text-muted">You can upload up to 10 images.</small>
                            </div>
                            <button type="submit" id="submitBtn" class="btn btn-danger w-100" disabled>
                                <i class="fas fa-tint"></i> Submit Blood Request
                            </button>
                        </form>
            </div>


            <!-- Inside the Become a Donor Tab -->
            <div id="donor" class="profile-tab">

                
            
                {% if donor %}
                    <div class="donor-profile-card">
                        <h5>Your Donor Profile</h5>
                        <p><strong>Status:</strong> {{ donor.status }}</p>
            
                        <div class="editable-field">
                            <label for="last_donation_date"><strong>Last Donation Date:</strong></label>
                            <input type="date" id="last_donation_date" value="{{ donor.last_donation_date or '' }}" class="form-control editable-input">
                        </div>
            
                        <div class="editable-field">
                            <label for="medical_conditions"><strong>Medical Conditions:</strong></label>
                            <textarea id="medical_conditions" class="form-control editable-input">{{ donor.medical_conditions or "None" }}</textarea>
                        </div>
            
                        <p><strong>NID/Birth Certificate:</strong> 
                            <a href="{{ url_for('static', filename='uploads/nid/' + donor.nid_or_birth_certificate) }}" target="_blank">View</a>
                        </p>
            
                        <button id="saveChangesBtn" class="btn btn-success">Save Changes</button>
                    </div>
            
                {% else %}
                    <form id="donorForm" method="POST" enctype="multipart/form-data" data-url="{{ url_for('become_donor') }}" class="donor-form">
                        {{ donor_application_form.hidden_tag() }}
                        {{ form.hidden_tag() }}
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" class="form-control" value="{{ user.username }}" readonly>
                        </div>
            
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" class="form-control" value="{{ user.email }}" readonly>
                        </div>
            
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" class="form-control" value="{{ user.address }}" readonly>
                        </div>
            
                        <div class="form-group">
                            <label>Date of Birth</label>
                            {{ donor_application_form.date_of_birth(class="form-control") }}
                        </div>
            
                        <div class="form-group">
                            <label>Upload NID or Birth Certificate</label>
                            {{ donor_application_form.nid_or_birth_certificate(class="form-control-file") }}
                        </div>
            
                        <div class="form-group">
                            <label>Have you donated blood before?</label>
                            <input type="checkbox" id="has_donated_before" name="has_donated_before" value="yes">
                        </div>
            
                        <div class="form-group last-donation-group" style="display: none;">
                            <label>Last Donation Date (if applicable)</label>
                            {{ donor_application_form.last_donation_date(class="form-control", id="last_donation_date") }}
                        </div>
            
                        <div class="form-group">
                            <label>Medical Conditions (if any)</label>
                            {{ donor_application_form.medical_conditions(class="form-control") }}
                        </div>
            
                        <div class="form-group">
                            <label>Upload Medical History Images (Optional)</label>
                            {{ donor_application_form.medical_history_images(class="form-control-file") }}
                        </div>
            
                        <button type="submit" class="btn btn-primary">Submit Application</button>
                    </form>
                {% endif %}
            </div>
            
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>

function showTab(event, tabId) {
    event.preventDefault();
    event.stopPropagation();

    document.querySelectorAll('.profile-tab').forEach(tab => tab.style.display = 'none');
    document.querySelectorAll('#profileTabs .nav-link').forEach(link => link.classList.remove('active'));

    document.getElementById(tabId).style.display = 'block';
    event.currentTarget.classList.add('active');

    // Close the navbar manually
    let navbarCollapse = document.querySelector('.navbar-collapse');
    if (navbarCollapse.classList.contains('show')) {
        new bootstrap.Collapse(navbarCollapse).hide();
    }
}

document.addEventListener("DOMContentLoaded", function () {
    let divisionId = "{{ user.division_id }}"; // Division ID from backend
    let districtId = "{{ user.district_id }}"; // District ID from backend
    let upazilaId = "{{ user.upazila_id }}"; // Upazila ID from backend

    // Select the dropdown elements
    const divisionSelect = document.getElementById("division");
    const districtSelect = document.getElementById("district");
    const upazilaSelect = document.getElementById("upazila");

    // Set the division value if it exists
    if (divisionId && divisionSelect.querySelector(`option[value="${divisionId}"]`)) {
        divisionSelect.value = divisionId;
        loadDistricts(divisionId, districtId, upazilaId);
    } else {
        divisionSelect.value = "";
        districtSelect.innerHTML = `<option value="">Select Division first</option>`;
        upazilaSelect.innerHTML = `<option value="">Select District First</option>`;
        districtSelect.disabled = true;
        upazilaSelect.disabled = true;

    }

    // Disable districts and upazilas if no division is selected
    if (!divisionId) {
        districtSelect.innerHTML = `<option value="">Select Division first</option>`;
        upazilaSelect.innerHTML = `<option value="">Select District First</option>`;
        districtSelect.disabled = true;
        upazilaSelect.disabled = true;
    }

    // Event listener for division change
    divisionSelect.addEventListener("change", function () {
        let selectedDivision = this.value;
        districtSelect.disabled = !selectedDivision;
        upazilaSelect.disabled = true;
        districtSelect.innerHTML = `<option value="">Loading...</option>`;
        upazilaSelect.innerHTML = `<option value="">Select District First</option>`;

        if (selectedDivision) {
            loadDistricts(selectedDivision);
        } else {
            districtSelect.innerHTML = `<option value="">Select Division first</option>`;
            districtSelect.disabled = true;
        }
    });

    // Event listener for district change
    districtSelect.addEventListener("change", function () {
        let selectedDistrict = this.value;
        upazilaSelect.disabled = !selectedDistrict;
        upazilaSelect.innerHTML = `<option value="">Loading...</option>`;

        if (selectedDistrict) {
            loadUpazilas(selectedDistrict);
        } else {
            upazilaSelect.innerHTML = `<option value="">Select District First</option>`;
            upazilaSelect.disabled = true;
        }
    });
});

function loadDistricts(selectedDivisionId, selectedDistrictId = null, selectedUpazilaId = null) {
    if (!selectedDivisionId) return;

    fetch(`/get_districts/${selectedDivisionId}`)
        .then(response => response.json())
        .then(data => {
            const districtSelect = document.getElementById("district");
            districtSelect.innerHTML = `<option value="">Select District</option>`;

            data.forEach(district => {
                let isSelected = selectedDistrictId && selectedDistrictId == district.id ? "selected" : "";
                districtSelect.innerHTML += `<option value="${district.id}" ${isSelected}>${district.name}</option>`;
            });

            districtSelect.disabled = false;

            if (selectedDistrictId) {
                loadUpazilas(selectedDistrictId, selectedUpazilaId);
            }
        })
        .catch(error => console.error("Error loading districts:", error));
}

function loadUpazilas(selectedDistrictId, selectedUpazilaId = null) {
    if (!selectedDistrictId) return;

    fetch(`/get_upazilas/${selectedDistrictId}`)
        .then(response => response.json())
        .then(data => {
            const upazilaSelect = document.getElementById("upazila");
            upazilaSelect.innerHTML = `<option value="">Select Upazila/City Corporation</option>`;

            data.forEach(upazila => {
                let isSelected = selectedUpazilaId && selectedUpazilaId == upazila.id ? "selected" : "";
                upazilaSelect.innerHTML += `<option value="${upazila.id}" ${isSelected}>${upazila.name}</option>`;
            });

            upazilaSelect.disabled = false;
        })
        .catch(error => console.error("Error loading upazilas:", error));
}

function enableEdit(fieldId) {
    let inputField = document.getElementById(fieldId);
    let button = inputField.nextElementSibling;

    if (inputField.readOnly) {
        inputField.readOnly = false;
        inputField.classList.add("border-primary");
        button.innerHTML = '<i class="fas fa-check"></i>';
        button.classList.replace("btn-outline-primary", "btn-success");
    } else {
        inputField.readOnly = true;
        inputField.classList.remove("border-primary");
        button.innerHTML = '<i class="fas fa-pencil-alt"></i>';
        button.classList.replace("btn-success", "btn-outline-primary");

        saveProfile(fieldId, inputField.value);
    }
}
function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
}


function uploadImage(type) {
    
    let inputElement = type === "profile" ? document.getElementById("profile-pic-input") : document.getElementById("cover-photo-input");
    let file = inputElement.files[0];

    if (!file) {
        showCustomModal({
            title: "No File Selected",
            message: "Please select an image to upload.",
            onConfirm: () => {}
        });
        return;
    }

    let formData = new FormData();
    formData.append("file", file);

    let uploadUrl = type === "profile" ? "/upload_profile_pic" : "/upload_cover_photo";

    fetch(uploadUrl, {
        method: "POST",
        headers: {
            'X-CSRFToken': getCSRFToken()
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.message.includes("updated")) {
            let imgElement = type === "profile" ? document.getElementById("profile-pic") : document.getElementById("cover-photo");
            imgElement.src = data.image_url + "?t=" + new Date().getTime(); // Prevents cache issues
            showCustomModal({
                title: "Success",
                message: data.message,
                onConfirm: () => {}
            });
        } else {
            showCustomModal({
                title: "Upload Failed",
                message: data.message,
                onConfirm: () => {}
            });
        }
    })
    .catch(error => {
        console.error("Upload error:", error);
        showCustomModal({
            title: "Error",
            message: "An error occurred while uploading the image.",
            onConfirm: () => {}
        });
    });
}
// Set initial active tab
document.querySelectorAll('.profile-tab').forEach(tab => tab.style.display = 'none');
document.getElementById('info').style.display = 'block';



function saveProfile(fieldId = null, value = null) {
    let updatedData = {
        name: document.getElementById("name").value,
        phone: document.getElementById("phone").value,
        blood_group: document.getElementById("blood_group").value,
        medical_history: document.getElementById("medical_history").value,
        address: document.getElementById("address").value,
        division_id: document.getElementById("division").value,
        district_id: document.getElementById("district").value,
        upazila_id: document.getElementById("upazila").value
    };

    if (fieldId && value !== null) {
        updatedData = { [fieldId]: value };
    }

    fetch("/update_profile", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify(updatedData)
    })
    .then(response => {
        const contentType = response.headers.get("content-type");
        if (!contentType || !contentType.includes("application/json")) {
            throw new Error("Invalid response from server. Check server logs.");
        }
        return response.json();
    })
    .then(data => {
        showCustomModal({
            title: "Success",
            message: data.message,
            onConfirm: () => {}
        });
    })
    .catch(error => {
        console.error("Update error:", error);
        showCustomModal({
            title: "Error",
            message: "An error occurred while updating profile.",
            onConfirm: () => {}
        });
    });
}


document.addEventListener("DOMContentLoaded", function () {
    const form = document.querySelector("form");
    const submitBtn = document.getElementById("submitBtn");  

    // Disable submit button initially
    submitBtn.disabled = true;

    // Validation rules
    const fields = {
        "patient_name": { min: 2, max: 100 },
        "hospital_name": { min: 2, max: 255 },
        "reason": { min: 5, max: 500 }
    };

    function validateField(input) {
        const fieldName = input.name;
        const value = input.value.trim();
        const errorContainer = input.nextElementSibling;

        if (!errorContainer) return false;  // âœ… Prevents `null` error

        if (fields[fieldName]) {
            const min = fields[fieldName].min;
            const max = fields[fieldName].max;

            if (value.length === 0) {
                errorContainer.textContent = "";  // No error for empty fields
                return false;
            } 
            else if (value.length < min) {
                errorContainer.textContent = `Too short (Min ${min} characters)`;
                return false;
            } 
            else if (value.length > max) {
                errorContainer.textContent = `Too long (Max ${max} characters)`;
                return false;
            } 
            else {
                errorContainer.textContent = "";
                return true;
            }
        }
        return true;
    }

    function validateForm() {
        let isValid = true;
        Object.keys(fields).forEach(field => {
            const input = document.querySelector(`[name="${field}"]`);
            if (input && !validateField(input)) {
                isValid = false;
            }
        });
        submitBtn.disabled = !isValid;
    }

    Object.keys(fields).forEach(field => {
        const input = document.querySelector(`[name="${field}"]`);
        if (input) {
            input.addEventListener("input", () => {
                validateField(input);
                validateForm();
            });

            input.addEventListener("blur", () => {
                validateField(input);
                validateForm();
            });
        }
    });

    validateForm();  // âœ… Run once to set initial state
});

let offset = 0;
const limit = 6;
let isLoading = false;
let hasMorePosts = true;

function loadMoreRequests() {
    
    if (isLoading || !hasMorePosts) return;

    isLoading = true;
    document.getElementById("loading-spinner").style.display = "block";

    fetch(`/load_past_requests?offset=${offset}&limit=${limit}`)
        .then(response => response.json())
        .then(data => {
            if (data.requests.length > 0) {
                console.log("loading requests, don't worry!", data.requests.length);
                data.requests.forEach(request => {
                    document.getElementById("request-feed").innerHTML += createPostHTML(request);
                });
                offset += limit;
                hasMorePosts = data.has_more;
            } else {
                hasMorePosts = false;
            }
        })
        .catch(error => {
        console.error("Fetching:", error);
        showCustomModal({
            title: "Error",
            message: "An error occurred while fetching the posts.",
            onConfirm: () => {}
        });
       })
        .finally(() => {
            isLoading = false;
            document.getElementById("loading-spinner").style.display = "none";
        });
}

// Trigger auto-load on scroll to bottom
window.addEventListener("scroll", () => {
    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100) {
        loadMoreRequests();
    }
});

// Initial load
window.onload = () => {
    loadMoreRequests();
};


// Function to determine badge color for urgency
function getUrgencyClass(status) {
    return status === "Critical" ? "danger" : status === "Urgent" ? "warning" : "primary";
}

// Function to generate HTML for each post
function createPostHTML(request) {
    let donorStatus = "";
    if (request.donors_assigned >= request.amount_needed) {
        donorStatus = "All Donors Assigned";
    } else if (request.donors_assigned > 0) {
        donorStatus = `${request.donors_assigned} out of ${request.amount_needed} Donors Assigned`;
    } else {
        donorStatus = "No Donor Yet";
    }

    let imagesHTML = "";
    let moreImages = request.images.length > 4 ? request.images.length - 4 : 0;

    if (request.images.length > 0) {
        imagesHTML = `
            <div class="post-images-container">
                ${request.images.slice(0, 4).map((img, index) => `
                    <div class="post-img-box">
                        <img src="/static/profile_pics/${img}" class="post-img" onclick="openSlider(${request.id}, ${index})">
                    </div>
                `).join('')}
                ${moreImages > 0 ? `
                    <div class="post-img-box more-images" onclick="openSlider(${request.id}, 0)">
                        +${moreImages} more
                    </div>
                ` : ""}
            </div>
        `;
    }

    return `
        <div class="card shadow-sm post-card mb-3" data-id="${request.id}" data-images='${JSON.stringify(request.images)}'>
            <!-- Options Button (3-dots) -->
            <div class="post-options">
                <button class="options-btn" onclick="toggleOptionsMenu(${request.id})">
                    <i class="fas fa-ellipsis-v"></i>
                </button>

                <!-- Options Dropdown -->
                <div class="options-menu" id="options-menu-${request.id}">
                    <button onclick="editPost(${request.id})"><i class="fas fa-edit"></i> Edit</button>
                    <button onclick="deletePost(${request.id})"><i class="fas fa-trash"></i> Delete</button>
                    <button onclick="markDonorFound(${request.id})"><i class="fas fa-check"></i> Donor Found</button>
                </div>
            </div>
            <div class="post-header d-flex align-items-center">
                <a href="/profile/${request.user.username}" class="fw-bold">
                    <img src="/static/profile_pics/${request.user.profile_picture}" class="post-profile-pic">
                </a>
                <div class="post-user-info">
                    <a href="/profile/${request.user.username}" class="fw-bold">${request.user.username}</a>
                    <div class="text-muted small">${convertToUserTime(request.created_at)}</div>
                </div>
            </div>
            <div class="post-body">
                <p><strong>Patient Name:</strong> ${request.patient_name}</p>
                <p><strong>Blood Group:</strong> ${request.blood_group}</p>
                <p><strong>Hospital:</strong> ${request.hospital_name}</p>
                <p><strong>Urgency:</strong> <span class="badge bg-${getUrgencyClass(request.urgency_status)}">${request.urgency_status}</span></p>
                <p><strong>Blood Needed:</strong> ${request.amount_needed} bag${request.amount_needed > 1 ? 's' : ''} (${request.amount_needed} donor${request.amount_needed > 1 ? 's' : ''} needed)</p>
                <p>${request.reason}</p>
                ${imagesHTML}
            </div>
            <div class="post-footer">
                <div class="status-bar ${request.status === 'Fulfilled' ? 'donor-assigned' : ''}">
                    <span id="assigned-donors-${request.id}">
                        ${donorStatus}
                    </span>
                </div>

                <div class="post-actions">
                    <button class="upvote-btn" data-id="${request.id}" onclick="upvotePost(${request.id})">
                        <i class="fas fa-thumbs-up"></i> <span id="upvote-count-${request.id}">${request.upvotes || 0}</span>
                    </button>
                    <button class="comment-toggle-btn" onclick="toggleComments(${request.id})">
                        <i class="fas fa-comment"></i> Comments
                    </button>
                </div>
                <div class="comments-section" id="comments-${request.id}"></div>

            </div>
        </div>
    `;
}
// Function to toggle options menu


function formatTime(dateStr) {
    const date = new Date(dateStr);
    return new Intl.DateTimeFormat(navigator.language, {
        dateStyle: 'medium',
        timeStyle: 'short'
    }).format(date);
}


// Function to close the modal

function upvotePost(postId) {
    fetch(`/upvote_request/${postId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({ post_id: postId })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Server responded with ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            document.getElementById(`upvote-count-${postId}`).innerText = data.upvotes;

            let upvoteBtn = document.querySelector(`.upvote-btn[data-id="${postId}"]`);
            if (upvoteBtn) {
                upvoteBtn.classList.toggle("upvoted");
            }
        } else {
            showCustomModal({
                title: "Error",
                message: data.error || "Unknown error occurred",
                onConfirm: () => {}
            });
        }
    })
    .catch(error => {
        console.error("Error upvoting post:", error);
        showCustomModal({
            title: "Upvote Failed",
            message: error.message || "Something went wrong.",
            onConfirm: () => {}
        });
    });
}





function convertToUserTime(utcString) {
    const utcFixed = utcString.endsWith("Z") ? utcString : utcString + "Z";
    const date = new Date(utcFixed);
    return date.toLocaleString(undefined, {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
    });
}


document.addEventListener("DOMContentLoaded", function () {
    // Ensure slider exists in the DOM
    if (!document.getElementById("image-slider")) {
        const sliderDiv = document.createElement("div");
        sliderDiv.id = "image-slider";
        sliderDiv.className = "image-slider";
        document.body.appendChild(sliderDiv);
    }

    // Close slider when clicking outside the image
    document.getElementById("image-slider").addEventListener("click", function (event) {
        if (event.target.id === "image-slider") {
            closeSlider();
        }
    });
});


document.addEventListener("DOMContentLoaded", function () {
    let donatedBeforeCheckbox = document.getElementById("has_donated_before");
    let lastDonationGroup = document.querySelector(".last-donation-group");

    if (donatedBeforeCheckbox) {
        donatedBeforeCheckbox.addEventListener("change", function () {
            lastDonationGroup.style.display = this.checked ? "block" : "none";
        });
    }

    // AJAX form submission for donor application
    let donorForm = document.getElementById("donorForm");
    if (donorForm) {
        donorForm.addEventListener("submit", function (event) {
            event.preventDefault();

            let formData = new FormData(this);
            let formUrl = this.getAttribute("data-url");

            fetch(formUrl, {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                alert("Request sent successfully");
                window.location.reload();
            })
            .catch(error => console.error("Error:", error));
        });
    }

    // Save Changes for donor profile (Editable fields)
    let saveChangesBtn = document.getElementById("saveChangesBtn");
    if (saveChangesBtn) {
        saveChangesBtn.addEventListener("click", function () {
            let lastDonationDate = document.getElementById("last_donation_date").value;
            let medicalConditions = document.getElementById("medical_conditions").value;

            fetch("/update_donor_info", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "x-csrf-token": getCSRFToken()
                },
                body: JSON.stringify({
                    last_donation_date: lastDonationDate,
                    medical_conditions: medicalConditions
                })
            })
            .then(response => response.json())
            .then(data => {
                alert("Changes saved successfully");
                window.location.reload();
            })
            .catch(error => console.error("Error:", error));
        });
    }
});




document.addEventListener("DOMContentLoaded", function () {
    const imageInput = document.getElementById("imageUpload");
    const previewContainer = document.getElementById("imagePreviews");
    const submitBtn = document.getElementById("submitBtn");

    let selectedFiles = [];

    imageInput.addEventListener("change", function () {
        const newFiles = Array.from(imageInput.files);

        newFiles.forEach(file => {
            if (!file.type.startsWith("image/")) return;

            if (selectedFiles.length >= 10) {
                alert("You can upload a maximum of 10 images.");
                return;
            }

            // Avoid duplicate names (optional)
            if (selectedFiles.some(f => f.name === file.name)) return;

            selectedFiles.push(file);

            const reader = new FileReader();
            reader.onload = function (e) {
                const wrapper = document.createElement("div");
                wrapper.classList.add("position-relative");

                const img = document.createElement("img");
                img.src = e.target.result;
                img.classList.add("rounded", "border");
                img.style.width = "100px";
                img.style.height = "100px";
                img.style.objectFit = "cover";

                const removeBtn = document.createElement("button");
                removeBtn.type = "button";
                removeBtn.innerText = "Ã—";
                removeBtn.classList.add("btn", "btn-sm", "btn-danger", "position-absolute");
                removeBtn.style.top = "0";
                removeBtn.style.right = "0";

                removeBtn.addEventListener("click", function () {
                    selectedFiles = selectedFiles.filter(f => f !== file);
                    wrapper.remove();
                    updateFileInput();
                });

                wrapper.appendChild(img);
                wrapper.appendChild(removeBtn);
                previewContainer.appendChild(wrapper);
            };

            reader.readAsDataURL(file);
        });

        updateFileInput();
    });

    function updateFileInput() {
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        imageInput.files = dt.files;

        submitBtn.disabled = selectedFiles.length > 10;
    }
});

function openPostModal(postId) {
    const postCard = document.querySelector(`.post-card[data-id="${postId}"]`);
    const postHTML = postCard.outerHTML;
    document.getElementById("modalPostContent").innerHTML = postHTML;
    new bootstrap.Modal(document.getElementById('postModal')).show();
}



</script>


   
{% endblock %}
